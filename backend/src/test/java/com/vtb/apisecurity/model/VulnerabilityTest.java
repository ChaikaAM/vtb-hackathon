package com.vtb.apisecurity.model;

import org.junit.jupiter.api.Test;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;

class VulnerabilityTest {

    @Test
    void vulnerabilityBuilder_shouldCreateVulnerability() {
        // when
        Vulnerability vuln = Vulnerability.builder()
                .id("vuln-1")
                .owaspCategory("API1:2023")
                .title("Broken Object Level Authorization")
                .description("Endpoint не проверяет авторизацию на уровне объекта")
                .severity(Vulnerability.Severity.HIGH)
                .endpoint("/api/users/{id}")
                .method("GET")
                .parameter("id")
                .evidence("Можно получить доступ к чужим данным")
                .recommendation("Добавить проверку прав доступа")
                .detectedAt(LocalDateTime.now())
                .build();

        // then
        assertThat(vuln.getId()).isEqualTo("vuln-1");
        assertThat(vuln.getOwaspCategory()).isEqualTo("API1:2023");
        assertThat(vuln.getSeverity()).isEqualTo(Vulnerability.Severity.HIGH);
        assertThat(vuln.getEndpoint()).isEqualTo("/api/users/{id}");
        assertThat(vuln.getMethod()).isEqualTo("GET");
    }

    @Test
    void vulnerability_shouldSupportAllSeverityLevels() {
        // given
        Vulnerability.Severity[] severities = Vulnerability.Severity.values();

        // then
        assertThat(severities).containsExactly(
                Vulnerability.Severity.CRITICAL,
                Vulnerability.Severity.HIGH,
                Vulnerability.Severity.MEDIUM,
                Vulnerability.Severity.LOW,
                Vulnerability.Severity.INFO
        );
    }

    @Test
    void vulnerability_shouldSupportDetailsMap() {
        // given
        Map<String, Object> details = new HashMap<>();
        details.put("cve", "CVE-2023-1234");
        details.put("score", 8.5);
        details.put("vector", "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H");

        // when
        Vulnerability vuln = Vulnerability.builder()
                .id("vuln-2")
                .title("Test Vulnerability")
                .severity(Vulnerability.Severity.CRITICAL)
                .details(details)
                .build();

        // then
        assertThat(vuln.getDetails()).isNotNull();
        assertThat(vuln.getDetails().get("cve")).isEqualTo("CVE-2023-1234");
        assertThat(vuln.getDetails().get("score")).isEqualTo(8.5);
    }

    @Test
    void vulnerability_shouldSupportAffectedEndpoints() {
        // given
        List<String> affectedEndpoints = List.of(
                "/api/users/{id}",
                "/api/accounts/{id}",
                "/api/transactions/{id}"
        );

        // when
        Vulnerability vuln = Vulnerability.builder()
                .id("vuln-3")
                .title("Broken Object Level Authorization")
                .severity(Vulnerability.Severity.HIGH)
                .affectedEndpoints(affectedEndpoints)
                .build();

        // then
        assertThat(vuln.getAffectedEndpoints()).hasSize(3);
        assertThat(vuln.getAffectedEndpoints()).contains("/api/users/{id}");
    }

    @Test
    void vulnerability_withAllFields_shouldWork() {
        // when
        LocalDateTime now = LocalDateTime.now();
        Vulnerability vuln = Vulnerability.builder()
                .id("full-vuln")
                .owaspCategory("API2:2023")
                .title("Broken Authentication")
                .description("Слабый механизм аутентификации")
                .severity(Vulnerability.Severity.MEDIUM)
                .endpoint("/api/login")
                .method("POST")
                .parameter("password")
                .evidence("Пароль передается в открытом виде")
                .recommendation("Использовать HTTPS и хеширование")
                .detectedAt(now)
                .build();

        // then
        assertThat(vuln.getId()).isEqualTo("full-vuln");
        assertThat(vuln.getDetectedAt()).isEqualTo(now);
        assertThat(vuln.getRecommendation()).isNotEmpty();
    }

    @Test
    void vulnerability_noArgsConstructor_shouldWork() {
        // when
        Vulnerability vuln = new Vulnerability();
        vuln.setId("test-id");
        vuln.setSeverity(Vulnerability.Severity.LOW);

        // then
        assertThat(vuln.getId()).isEqualTo("test-id");
        assertThat(vuln.getSeverity()).isEqualTo(Vulnerability.Severity.LOW);
    }
}
